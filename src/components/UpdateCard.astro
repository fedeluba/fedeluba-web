---
import financesData from '../data/finances.yaml';

interface Props {
  title: string;
  date: Date;
  investedMoney: number; // Change amount (can be + or -)
  defiIncome: number; // DeFi income (always positive)
  highlights: string[];
  slug: string;
  index?: number;
}

const { title, date, investedMoney, defiIncome, highlights, slug, index = 0 } = Astro.props;

const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
});

const formatRelative = (amount: number, forcePositive = false) => {
  const prefix = amount >= 0 || forcePositive ? '+' : '-';
  return prefix + new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(Math.abs(amount));
};

const isPositiveInvestment = investedMoney >= 0;

// Calculate portfolio performance % from history
const history = (financesData as any).history as { month: string; amount: number }[];
// Use UTC to avoid timezone issues with YAML date parsing
const updateMonth = `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}`;
const sortedHistory = [...history].sort((a, b) => b.month.localeCompare(a.month));
const currentMonthIndex = sortedHistory.findIndex(h => h.month === updateMonth);
const currentMonthValue = currentMonthIndex >= 0 ? sortedHistory[currentMonthIndex].amount : null;
const previousMonthValue = currentMonthIndex >= 0 && currentMonthIndex < sortedHistory.length - 1 
  ? sortedHistory[currentMonthIndex + 1].amount 
  : null;

let performancePercent: number | null = null;
if (currentMonthValue !== null && previousMonthValue !== null && previousMonthValue > 0) {
  performancePercent = ((currentMonthValue - previousMonthValue) / previousMonthValue) * 100;
}

const isPositivePerformance = performancePercent !== null && performancePercent >= 0;
---

<a 
  href={`/updates/${slug}`}
  class="group block rounded-xl border border-[var(--color-border)] bg-[var(--color-card)] p-5 no-underline transition-base hover:border-[var(--color-text-muted)] hover:shadow-lg hover:shadow-black/5 animate-fade-in-up"
  style={`animation-delay: ${index * 100}ms`}
>
  <div class="flex items-start justify-between gap-4">
    <div class="flex-1">
      <div class="flex items-center gap-2">
        <time class="text-xs font-mono text-[var(--color-text-muted)] uppercase tracking-wider">
          {formattedDate}
        </time>
        {performancePercent !== null && (
          <span class:list={[
            "inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-xs font-mono",
            isPositivePerformance 
              ? "bg-green-500/10 text-[var(--color-success)]" 
              : "bg-red-500/10 text-red-500"
          ]}>
            {isPositivePerformance ? '↑' : '↓'} {Math.abs(performancePercent).toFixed(1)}%
          </span>
        )}
      </div>
      <h3 class="mt-1 font-serif text-xl font-normal text-[var(--color-text)] group-hover:text-[var(--color-accent)] transition-base">
        {title}
        <svg 
          class="ml-1 inline-block size-3.5 opacity-0 -translate-x-1 transition-base group-hover:opacity-100 group-hover:translate-x-0" 
          fill="none" 
          viewBox="0 0 24 24" 
          stroke="currentColor" 
          stroke-width="2"
        >
          <path d="M9 5l7 7-7 7" />
        </svg>
      </h3>
    </div>
    <div class="text-right flex gap-4">
      <div>
        <span class="block text-xs text-[var(--color-text-muted)]">Invested</span>
        <p class:list={[
          "font-mono text-sm font-medium",
          isPositiveInvestment ? "text-[var(--color-success)]" : "text-red-500"
        ]}>
          {formatRelative(investedMoney)}
        </p>
      </div>
      <div>
        <span class="block text-xs text-[var(--color-text-muted)]">DeFi Income</span>
        <p class="font-mono text-sm font-medium text-[var(--color-success)]">
          {formatRelative(defiIncome, true)}
        </p>
      </div>
    </div>
  </div>
  
  {highlights.length > 0 && (
    <ul class="mt-3 space-y-1">
      {highlights.slice(0, 3).map((highlight) => (
        <li class="flex items-start gap-2 text-sm text-[var(--color-text-secondary)]">
          <span class="mt-1.5 size-1.5 shrink-0 rounded-full bg-[var(--color-accent)]" />
          {highlight}
        </li>
      ))}
    </ul>
  )}
</a>
